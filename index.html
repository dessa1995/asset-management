<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>생애주기 자산관리 계획</title>
    <!-- 외부 라이브러리 로드: Chart.js (그래프), jspdf & html2canvas (PDF 생성) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* 폰트 및 기본 스타일 */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        :root {
            --primary-color: #4A90E2; /* 신뢰감을 주는 파란색 */
            --secondary-color: #50E3C2; /* 포인트 녹색 */
            --light-bg-color: #F7F9FC; /* 밝은 배경색 */
            --white-color: #FFFFFF;
            --dark-text-color: #333333; /* 기본 텍스트 색 */
            --light-text-color: #767676; /* 연한 텍스트 색 */
            --border-color: #E0E0E0;
            --error-color: #D0021B;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --card-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--light-bg-color);
            color: var(--dark-text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.6;
        }

        /* 화면 전환 애니메이션 */
        .screen {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .screen.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 레이아웃 */
        .container {
            max-width: 1000px; /* 그리드 레이아웃을 위해 너비 확장 */
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 100px; /* 고정 푸터 공간 확보 */
        }
        header {
            text-align: center;
            margin-bottom: 40px;
        }
        header h1 {
            font-size: 2.2rem;
            color: var(--primary-color);
            font-weight: 700;
        }
        header p {
            font-size: 1.1rem;
            color: var(--light-text-color);
        }

        /* 2x2 그리드 레이아웃 */
        .stage-grid-row {
            display: flex;
            gap: 25px;
            margin-bottom: 25px;
        }
        .stage-grid-item {
            flex: 1;
            min-width: 0; /* flex item이 수축할 수 있도록 */
        }

        /* 카드 스타일 */
        .card {
            background-color: var(--white-color);
            border-radius: 12px;
            padding: 25px;
            height: 100%; /* 그리드 아이템 높이 통일 */
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
            opacity: 0;
            transform: translateY(50px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .card.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }
        .card-header h2 {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        /* 폼 요소 스타일 */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: flex;
            align-items: center;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 1rem;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Noto Sans KR', sans-serif;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }
        .form-group input.invalid,
        .form-group textarea.invalid {
            border-color: var(--error-color);
            box-shadow: 0 0 0 2px rgba(208, 2, 27, 0.2);
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        .korean-won {
            font-size: 0.9rem;
            color: var(--primary-color);
            font-weight: 500;
            margin-top: 5px;
            height: 1em;
        }
        .user-info-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* 버튼 스타일 */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:active {
            transform: translateY(1px);
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white-color);
        }
        .btn-primary:hover {
            background-color: #3a7ac8;
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.4);
        }
        .btn-secondary {
            background-color: var(--white-color);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }
        .btn-secondary:hover {
            background-color: #f0f6ff;
        }
        .btn-tip {
            background-color: var(--secondary-color);
            color: var(--white-color);
            font-size: 0.9rem;
            padding: 8px 14px;
        }
        .btn-tip:hover {
            background-color: #3bcba8;
        }
        .btn-help {
            background: none;
            border: 1px solid var(--light-text-color);
            color: var(--light-text-color);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 0.8rem;
            margin-left: 8px;
            padding: 0;
            line-height: 18px;
        }

        /* 툴팁 스타일 */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: #555;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* 모달 및 알림 스타일 */
        .modal, .alert-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            animation: slideInUp 0.4s;
            text-align: center;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 20px;
            text-align: left;
        }
        .modal-header h2 {
            color: var(--primary-color);
        }
        .close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: black;
        }
        .modal-body ul {
            list-style: none;
            text-align: left;
        }
        .modal-body li {
            margin-bottom: 15px;
            font-size: 1rem;
        }
        .modal-body li::before {
            content: '✅';
            margin-right: 10px;
        }
        #alert-modal .modal-content {
            max-width: 400px;
        }
        #alert-modal p {
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        /* 고정 푸터 */
        .sticky-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--white-color);
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 100;
        }
        .sticky-footer .btn {
            width: 100%;
            max-width: 200px;
            padding: 15px;
            font-size: 1.1rem;
        }

        /* 결과 페이지 스타일 */
        #result-screen h1 {
            margin-bottom: 10px;
        }
        .result-summary {
            text-align: center;
            margin-bottom: 30px;
        }
        .grades-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            flex-wrap: wrap;
            margin: 1.5rem 0;
        }
        .grade-display {
            display: inline-block;
            width: 80px;
            height: 80px;
            line-height: 80px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: var(--white-color);
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0 auto;
            box-shadow: var(--shadow);
        }
        .advice-section {
            cursor: pointer;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            transition: background-color 0.3s;
        }
        .advice-section:hover {
            background-color: #f0f6ff;
        }
        .advice-title {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary-color);
        }
        .advice-content {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--border-color);
        }
        .advice-content ul {
            list-style-position: inside;
            padding-left: 10px;
        }
         .advice-content li {
            margin-bottom: 10px;
        }
        .chart-container {
            position: relative;
            height: 40vh;
            max-height: 400px;
            width: 100%;
        }
        
        /* 로딩 스피너 */
        .loader-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            gap: 20px;
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-radius: 50%;
            border-top: 8px solid var(--primary-color);
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* PDF 출력용 스타일 (개선) */
        .pdf-render-area {
            position: absolute;
            left: -9999px;
            top: auto;
            width: 800px;
            background: var(--white-color);
        }
        .pdf-section {
            padding: 20px;
            color: var(--dark-text-color);
            page-break-inside: avoid;
        }
        .pdf-section h1 {
            font-size: 24px;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 30px;
            border: none;
        }
        .pdf-section h3 {
            font-size: 18px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
            margin-top: 25px;
            margin-bottom: 20px;
        }
        .pdf-section p {
            margin-bottom: 12px;
            font-size: 14px;
        }
        .pdf-section .label {
            font-weight: 700;
            color: var(--dark-text-color);
            display: block;
            margin-bottom: 5px;
        }
        .pdf-section .value {
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 12px;
            background: var(--light-bg-color);
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.7;
        }
        .pdf-section .pdf-chart-img {
            max-width: 100%;
            margin-top: 20px;
        }
        .pdf-grades-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            flex-wrap: wrap;
            margin: 1.5rem 0;
        }


        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .stage-grid-row {
                flex-direction: column;
                margin-bottom: 0;
            }
            .stage-grid-item {
                margin-bottom: 25px;
            }
            .user-info-container {
                flex-direction: column;
                gap: 0;
            }
        }
        @media (max-width: 600px) {
            .container {
                padding: 15px;
                padding-bottom: 80px;
            }
            header h1 {
                font-size: 1.8rem;
            }
            .card {
                padding: 20px;
            }
            .card-header h2 {
                font-size: 1.3rem;
            }
            .sticky-footer {
                padding: 10px;
                flex-direction: column;
                gap: 10px;
            }
            .sticky-footer .btn {
                max-width: 100%;
                padding: 12px;
                font-size: 1rem;
            }
            .modal-content {
                width: 90%;
            }
        }
    </style>
</head>
<body>
    <!-- 입력 화면 -->
    <div id="input-screen" class="screen active">
        <div class="container">
            <header>
                <h1>생애주기 자산관리 계획</h1>
                <p>당신의 미래를 위한 재무 계획을 세워보세요.</p>
            </header>
            <form id="asset-form">
                <div class="card visible">
                    <div class="card-header">
                        <h2>기본 정보</h2>
                    </div>
                    <div class="user-info-container">
                        <div class="form-group" style="flex:1;">
                            <label for="student-id">학번</label>
                            <input type="text" id="student-id" name="student-id" placeholder="학번을 입력하세요" required>
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label for="student-name">이름</label>
                            <input type="text" id="student-name" name="student-name" placeholder="이름을 입력하세요" required>
                        </div>
                    </div>
                </div>
                <!-- 생애주기별 입력 섹션이 동적으로 추가될 영역 -->
                <div id="stages-container"></div>
            </form>
        </div>
        <div class="sticky-footer">
            <button type="button" id="submit-btn" class="btn btn-primary">입력 완료</button>
        </div>
    </div>

    <!-- 결과 화면 -->
    <div id="result-screen" class="screen">
        <div class="container">
            <header>
                <h1>자산관리 계획 분석 결과</h1>
            </header>
            
            <div class="card visible">
                <div class="card-header">
                    <h2>종합 평가</h2>
                </div>
                <div class="result-summary">
                    <p>각 생애주기별 계획의 완성도입니다.</p>
                    <div id="grades-container" class="grades-container">
                        <!-- 등급이 여기에 표시됩니다. -->
                    </div>
                </div>
            </div>

            <div class="card visible">
                <div class="card-header">
                    <h2>시기별 필요 자금</h2>
                </div>
                <div class="chart-container">
                    <canvas id="asset-chart"></canvas>
                </div>
            </div>

            <div class="card visible">
                <div class="card-header">
                    <h2>상세 조언</h2>
                </div>
                <div id="advice-container">
                    <!-- 조언이 여기에 표시됩니다. -->
                </div>
            </div>

            <div class="card visible">
                <div class="card-header">
                    <h2>앞으로의 다짐</h2>
                </div>
                <div class="form-group">
                    <textarea id="commitment" placeholder="분석 결과를 바탕으로 앞으로의 자산관리 계획에 대한 다짐을 자유롭게 작성해보세요."></textarea>
                </div>
            </div>
        </div>
        <div class="sticky-footer">
            <button type="button" id="modify-btn" class="btn btn-secondary">수정하기</button>
            <button type="button" id="download-pdf-btn" class="btn btn-primary">PDF로 저장</button>
            <button type="button" id="restart-btn" class="btn btn-secondary">다시 시작</button>
        </div>
    </div>

    <!-- 팁 보기 모달 -->
    <div id="tip-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title"></h2>
                <span class="close-btn">&times;</span>
            </div>
            <div id="modal-body" class="modal-body"></div>
        </div>
    </div>

    <!-- 알림 모달 -->
    <div id="alert-modal" class="alert-modal">
        <div class="modal-content">
            <p id="alert-message"></p>
            <button id="alert-close-btn" class="btn btn-primary">확인</button>
        </div>
    </div>

    <!-- 로딩 스피너 -->
    <div id="loader" class="loader-wrapper">
        <div class="loader"></div>
        <p>PDF를 생성 중입니다. 잠시만 기다려주세요...</p>
    </div>
    
    <!-- PDF 생성용 숨겨진 컨텐츠 영역 -->
    <div id="pdf-render-area" class="pdf-render-area"></div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- 데이터 및 설정 ---
            const stages = [
                { id: 'childhood', name: '유소년기 (0~19세)' },
                { id: 'youth', name: '청년기 (20~34세)' },
                { id: 'middle-age', name: '중장년기 (35~64세)' },
                { id: 'old-age', name: '노년기 (65세~)' }
            ];

            const tips = {
                childhood: {
                    title: '유소년기 자산관리 팁',
                    list: [
                        '<b>용돈 관리의 시작:</b> 정기적인 용돈을 받고 일부는 저축하는 습관을 들이세요.',
                        '<b>저축 습관 형성:</b> 목표를 정하고 그에 맞춰 저축하는 방법을 배우세요.',
                        '<b>금융 교육:</b> 기본적인 금융 개념(저축, 이자, 복리)을 이해하는 것이 중요합니다.',
                        '<b>소비 습관:</b> 필요한 것과 원하는 것의 차이를 구분하는 법을 배우세요.',
                        '<b>장기적 관점:</b> 작은 금액이라도 꾸준히 모으면 큰 금액이 된다는 것을 경험해보세요.'
                    ]
                },
                youth: {
                    title: '청년기 자산관리 팁',
                    list: [
                        '<b>비상금 마련:</b> 최소 3-6개월치 생활비를 비상금으로 마련하세요.',
                        '<b>부채 관리:</b> 학자금 대출이 있다면 상환 계획을 세우고 고금리 부채부터 갚아나가세요.',
                        '<b>투자 시작:</b> 소액으로 시작해 투자의 기본을 배우고 복리의 힘을 활용하세요.',
                        '<b>직업 역량 강화:</b> 자신의 직업 역량에 투자하는 것도 중요한 자산관리입니다.',
                        '<b>보험 가입:</b> 기본적인 보장성 보험에 가입하여 위험에 대비하세요.'
                    ]
                },
                'middle-age': {
                    title: '중장년기 자산관리 팁',
                    list: [
                        '<b>은퇴 계획:</b> 은퇴 후 필요한 자금을 계산하고 준비 계획을 세우세요.',
                        '<b>자산 다각화:</b> 주식, 채권, 부동산 등 다양한 자산에 분산 투자하세요.',
                        '<b>자녀 교육비:</b> 자녀 교육을 위한 별도의 자금을 계획적으로 마련하세요.',
                        '<b>보험 재점검:</b> 현재 상황에 맞게 보험 보장 내용을 재점검하세요.',
                        '<b>부채 상환:</b> 은퇴 전에 주택담보대출 등 주요 부채를 상환하는 계획을 세우세요.'
                    ]
                },
                'old-age': {
                    title: '노년기 자산관리 팁',
                    list: [
                        '<b>안정적 수입원:</b> 연금, 이자, 배당 등 안정적인 수입원을 확보하세요.',
                        '<b>의료비 대비:</b> 노년기 의료비 지출에 대비한 자금을 별도로 마련하세요.',
                        '<b>자산 보존:</b> 리스크를 줄이고 자산을 보존하는 전략으로 전환하세요.',
                        '<b>상속 계획:</b> 필요하다면 상속 계획을 미리 세워두세요.',
                        '<b>지출 관리:</b> 은퇴 후 달라진 생활 패턴에 맞게 지출 계획을 조정하세요.'
                    ]
                }
            };
            
            const examples = {
                goal: '예) 20대 후반, 첫 내 집 마련을 위한 종잣돈 1억 원 모으기. 이를 위해 매달 150만 원씩 저축하고, 주식과 예금에 7:3 비율로 투자할 계획입니다.',
                funds: '예) 결혼자금 5천만 원, 주택 구입 선수금 1억 원 등 구체적인 목표 금액을 입력하세요.',
                portfolio: '예) 안정적인 현금 흐름을 위해 예금과 적금을 50% 비중으로 가져가고, 장기적인 수익률을 위해 국내 우량주 및 미국 기술주에 30%, 나머지 20%는 채권에 투자하여 포트폴리오를 다각화할 계획입니다.'
            };

            let planData = {};
            let assetChart = null;

            // --- DOM 요소 ---
            const inputScreen = document.getElementById('input-screen');
            const resultScreen = document.getElementById('result-screen');
            const stagesContainer = document.getElementById('stages-container');
            const submitBtn = document.getElementById('submit-btn');
            const modifyBtn = document.getElementById('modify-btn');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            const restartBtn = document.getElementById('restart-btn');
            const tipModal = document.getElementById('tip-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const closeModalBtn = tipModal.querySelector('.close-btn');
            const loader = document.getElementById('loader');
            const alertModal = document.getElementById('alert-modal');
            const alertMessage = document.getElementById('alert-message');
            const alertCloseBtn = document.getElementById('alert-close-btn');

            // --- 함수 ---

            function showAlert(message) {
                alertMessage.textContent = message;
                alertModal.style.display = 'flex';
            }

            function numberToKorean(num) {
                if (isNaN(num) || !num) return '0원';
                const units = ['', '만', '억', '조', '경'];
                const numStr = String(num);
                let result = '';
                let unitIndex = 0;
                for (let i = numStr.length; i > 0; i -= 4) {
                    const chunk = numStr.substring(Math.max(0, i - 4), i);
                    if (parseInt(chunk, 10) > 0) {
                        result = `${parseInt(chunk, 10).toLocaleString()}${units[unitIndex]} ${result}`;
                    }
                    unitIndex++;
                }
                return result.trim() + '원';
            }

            function createInputForm() {
                let formHtml = '';
                for (let i = 0; i < stages.length; i += 2) {
                    formHtml += '<div class="stage-grid-row">';
                    formHtml += createStageCardHtml(stages[i]);
                    if (stages[i + 1]) {
                        formHtml += createStageCardHtml(stages[i + 1]);
                    }
                    formHtml += '</div>';
                }
                stagesContainer.innerHTML = formHtml;
                observeCards();
            }

            function createStageCardHtml(stage) {
                return `
                    <div class="stage-grid-item">
                        <div class="card" data-stage="${stage.id}">
                            <div class="card-header">
                                <h2>${stage.name}</h2>
                                <button type="button" class="btn btn-tip" data-stage="${stage.id}">팁 보기</button>
                            </div>
                            <div class="form-group">
                                <label for="${stage.id}-goal">
                                    경제 목표
                                    <div class="tooltip">
                                        <button type="button" class="btn-help">?</button>
                                        <span class="tooltip-text">${examples.goal}</span>
                                    </div>
                                </label>
                                <textarea id="${stage.id}-goal" name="${stage.id}-goal" rows="3" placeholder="구체적인 경제적 목표를 작성해주세요." required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="${stage.id}-funds">
                                    필요 자금 (원)
                                    <div class="tooltip">
                                        <button type="button" class="btn-help">?</button>
                                        <span class="tooltip-text">${examples.funds}</span>
                                    </div>
                                </label>
                                <input type="number" id="${stage.id}-funds" name="${stage.id}-funds" placeholder="숫자만 입력하세요 (예: 50000000)" required>
                                <div class="korean-won" id="${stage.id}-funds-kor"></div>
                            </div>
                            <div class="form-group">
                                <label for="${stage.id}-portfolio">
                                    자산 포트폴리오
                                    <div class="tooltip">
                                        <button type="button" class="btn-help">?</button>
                                        <span class="tooltip-text">${examples.portfolio}</span>
                                    </div>
                                </label>
                                <textarea id="${stage.id}-portfolio" name="${stage.id}-portfolio" rows="3" placeholder="어떤 자산에 어떻게 투자할지 계획을 작성해주세요." required></textarea>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            function observeCards() {
                const cards = document.querySelectorAll('.card');
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('visible');
                        }
                    });
                }, { threshold: 0.1 });

                cards.forEach(card => {
                    observer.observe(card);
                });
            }

            function evaluatePlan(data) {
                const { goal, funds, portfolio } = data;
                if (!goal || !funds || !portfolio) return 'D';

                const portfolioKeywords = ['주식', '채권', '예금', '보험', '저축', '투자', '코인', '부동산', '적금'];
                const foundKeywords = portfolioKeywords.filter(kw => portfolio.includes(kw)).length;

                if (goal.length >= 80 && foundKeywords >= 2) return 'A';
                if (goal.length >= 50) return 'B';
                return 'C';
            }

            function getAdvice(grade, stageName) {
                switch(grade) {
                    case 'A': return `<b>${stageName} 계획이 매우 구체적이고 훌륭합니다!</b> 현재 계획을 꾸준히 실천하며, 정기적으로 시장 상황과 자신의 재무 상태를 점검하여 유연하게 조정해나가는 것을 추천합니다.`;
                    case 'B': return `<b>${stageName} 계획의 방향성이 좋습니다.</b> 목표를 조금 더 구체적인 수치로 표현하고, 포트폴리오의 비중을 명확히 설정하면 더욱 실현 가능한 계획이 될 것입니다.`;
                    case 'C': return `<b>${stageName} 계획의 기본 틀이 잡혔습니다.</b> 이제 각 항목에 대해 더 깊이 고민해볼 시간입니다. '왜' 이 목표를 세웠는지, '어떻게' 달성할 것인지 구체적인 실행 방안을 추가해보세요.`;
                    case 'D': return `<b>${stageName} 계획에 빈 항목이 있습니다.</b> 모든 항목을 채워야 전체적인 재무 계획을 세울 수 있습니다. 시간을 갖고 각 항목에 대해 곰곰이 생각해보는 것을 추천합니다.`;
                    default: return '';
                }
            }

            /**
             * 전체 평균 등급에 따른 종합 조언 생성 함수 (신규)
             * @param {string[]} grades - 생애주기별 등급 배열
             * @returns {string} - HTML 형식의 종합 조언
             */
            function getOverallAdvice(grades) {
                const scoreMap = { 'A': 4, 'B': 3, 'C': 2, 'D': 1 };
                const totalScore = grades.reduce((sum, grade) => sum + scoreMap[grade], 0);
                const averageScore = totalScore / grades.length;

                if (averageScore >= 3.5) { // 평균 A 이상
                    return `
                        <h3>종합 조언 (매우 우수)</h3>
                        <p><b>전반적으로 매우 체계적이고 실현 가능성이 높은 계획입니다!</b> 각 생애주기에 대한 깊은 고민이 엿보이며, 구체적인 목표와 전략이 잘 수립되어 있습니다.</p>
                        <ul>
                            <li><b>지속성 유지:</b> 현재의 계획을 꾸준히 실천하고 정기적으로 진행 상황을 점검하는 것이 중요합니다.</li>
                            <li><b>유연한 대처:</b> 인생의 예기치 못한 변화(결혼, 출산, 이직 등)에 따라 계획을 유연하게 수정할 준비를 하세요.</li>
                            <li><b>심화 학습:</b> 현재의 지식에 만족하지 않고, 새로운 금융 상품이나 투자 트렌드에 대해 지속적으로 학습하여 계획을 더욱 발전시켜 나가시길 바랍니다.</li>
                        </ul>
                        <p><b>훌륭한 출발입니다! 이 계획이 당신의 풍요로운 미래를 위한 튼튼한 초석이 될 것입니다.</b></p>
                    `;
                } else if (averageScore >= 2.5) { // 평균 B 이상
                    return `
                        <h3>종합 조언 (우수)</h3>
                        <p><b>전체적으로 좋은 방향성을 가진 훌륭한 계획입니다.</b> 자산 관리에 대한 기본적인 이해도가 높으며, 미래를 위한 좋은 토대를 마련하셨습니다.</p>
                        <ul>
                            <li><b>목표 구체화:</b> '돈 많이 벌기'와 같은 추상적인 목표보다는 '35세까지 1억 모으기'처럼 SMART(구체적, 측정가능, 달성가능, 관련성, 시간기반) 원칙에 따라 목표를 더욱 명확하게 설정해보세요.</li>
                            <li><b>위험 관리:</b> 일부 기간의 포트폴리오가 한쪽에 치우쳐 있을 수 있습니다. 분산 투자의 원칙을 다시 한번 점검하고, 예상치 못한 위험에 대비한 비상금의 중요성을 잊지 마세요.</li>
                            <li><b>실행 계획 점검:</b> 각 목표를 달성하기 위한 월별 저축액이나 투자 계획이 현실적인지 다시 한번 검토해보는 것이 좋습니다.</li>
                        </ul>
                        <p><b>몇 가지만 보완한다면 더욱 완벽한 계획이 될 것입니다. 지금처럼 꾸준히 나아가세요!</b></p>
                    `;
                } else if (averageScore >= 1.5) { // 평균 C 이상
                    return `
                        <h3>종합 조언 (개선 필요)</h3>
                        <p><b>미래를 위한 계획을 시작했다는 것만으로도 큰 의미가 있습니다.</b> 다만, 현재 계획은 다소 추상적이거나 구체성이 부족한 부분이 보입니다.</p>
                        <ul>
                            <li><b>기초부터 탄탄히:</b> 각 생애주기별 '팁 보기' 기능을 활용하여 해당 시기에 꼭 필요한 재무 활동이 무엇인지 다시 한번 확인해보세요.</li>
                            <li><b>숫자로 계획하기:</b> '필요 자금'을 단순히 큰 금액으로 설정하기보다, 왜 그 금액이 필요한지(주택 구매, 자녀 교육 등) 구체적인 근거를 바탕으로 산출하는 연습이 필요합니다.</li>
                            <li><b>현실성 점검:</b> 목표를 달성하기 위한 과정이 현실적으로 가능한지, 나의 예상 소득과 지출을 고려하여 계획을 수정해보세요.</li>
                        </ul>
                        <p><b>이번 계획을 바탕으로 각 항목을 조금 더 구체화한다면 훨씬 더 강력한 미래 설계도가 될 것입니다.</b></p>
                    `;
                } else { // 평균 D 수준
                    return `
                        <h3>종합 조언 (상당한 노력 필요)</h3>
                        <p><b>자산 관리 계획의 첫걸음을 뗀 것을 응원합니다.</b> 아직은 계획의 전체적인 틀을 잡는 데 어려움이 있는 것으로 보입니다.</p>
                        <ul>
                            <li><b>정보 탐색의 중요성:</b> 각 생애주기별 '팁 보기' 내용을 꼼꼼히 읽어보는 것부터 시작해보세요. 어떤 준비가 필요한지 아는 것이 계획의 첫 단계입니다.</li>
                            <li><b>작은 목표부터 시작:</b> 처음부터 거창한 계획을 세우기보다, '유소년기에 용돈 10% 저축하기'와 같이 작고 실천 가능한 목표부터 세우고 달성하는 경험을 쌓는 것이 중요합니다.</li>
                            <li><b>빈칸 채우기:</b> 계획의 완성도를 높이기 위해, 비어있는 모든 항목에 대해 고민하고 채워 넣는 노력이 필요합니다.</li>
                        </ul>
                        <p><b>누구나 처음은 어렵습니다. 이 프로그램을 여러 번 활용하여 점차 발전하는 자신의 계획을 확인해보세요!</b></p>
                    `;
                }
            }


            function generateResults() {
                const gradesContainer = document.getElementById('grades-container');
                const adviceContainer = document.getElementById('advice-container');
                gradesContainer.innerHTML = '';
                adviceContainer.innerHTML = '';
                
                const grades = [];

                stages.forEach(stage => {
                    const data = planData[stage.id];
                    const grade = evaluatePlan(data);
                    data.grade = grade;
                    grades.push(grade); // 평균 계산을 위해 등급 저장

                    gradesContainer.innerHTML += `
                        <div class="text-center">
                            <div class="grade-display" style="background-color:${grade === 'A' ? '#4A90E2' : grade === 'B' ? '#50E3C2' : grade === 'C' ? '#F5A623' : '#D0021B'}">${grade}</div>
                            <p class="mt-2 font-weight-bold">${stage.name}</p>
                        </div>
                    `;

                    const stageAdvice = getAdvice(grade, stage.name);
                    adviceContainer.innerHTML += `
                        <div class="advice-section mb-2">
                            <div class="advice-title">${stage.name} 조언 (등급: ${grade})</div>
                            <div class="advice-content">${stageAdvice}</div>
                        </div>
                    `;
                });
                
                // 새로운 종합 조언 생성
                const overallAdvice = getOverallAdvice(grades);
                
                adviceContainer.innerHTML += `
                    <div class="advice-section mt-3">
                        <div class="advice-title">전체 생애주기 종합 조언</div>
                        <div class="advice-content">${overallAdvice}</div>
                    </div>
                `;

                document.querySelectorAll('.advice-section').forEach(el => {
                    el.addEventListener('click', () => {
                        const content = el.querySelector('.advice-content');
                        content.style.display = content.style.display === 'block' ? 'none' : 'block';
                    });
                });

                renderChart();
                switchScreen('result-screen');
            }

            function renderChart() {
                const ctx = document.getElementById('asset-chart').getContext('2d');
                const labels = stages.map(s => s.name);
                // 로그 스케일에서 0은 유효하지 않으므로, 0인 경우 그래프 하단에 표시될 작은 값(예: 1)으로 매핑합니다.
                const data = stages.map(s => planData[s.id].funds > 0 ? planData[s.id].funds : 1);
                
                if(assetChart) {
                    assetChart.destroy();
                }

                assetChart = new Chart(ctx, {
                    type: 'line', // 그래프 타입을 'line'으로 변경
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '필요 자금 (원)',
                            data: data,
                            fill: true, // 선 아래 영역 채우기
                            backgroundColor: 'rgba(74, 144, 226, 0.2)', // 영역 색상
                            borderColor: 'rgba(74, 144, 226, 1)', // 선 색상
                            pointBackgroundColor: 'rgba(74, 144, 226, 1)', // 포인트 색상
                            pointRadius: 5, // 포인트 크기
                            tension: 0.1 // 선의 곡률
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) label += ': ';
                                        // 툴팁에는 원래 값을 표시
                                        const originalValue = planData[stages[context.dataIndex].id].funds;
                                        if (originalValue !== null) {
                                            label += new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(originalValue);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'logarithmic', // 로그 스케일로 변경
                                min: 1000, // 0에 가까운 값들이 잘 보이도록 최소값을 1000원 정도로 설정
                                ticks: {
                                    callback: function(value, index, values) {
                                        // numberToKorean 함수를 사용하여 주요 단위를 표시
                                        return numberToKorean(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }

            function switchScreen(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');
                window.scrollTo(0, 0);
            }
            
            function resetApp() {
                planData = {};
                document.getElementById('asset-form').reset();
                document.querySelectorAll('.korean-won').forEach(el => el.textContent = '');
                document.getElementById('commitment').value = '';
                if (assetChart) {
                    assetChart.destroy();
                    assetChart = null;
                }
                switchScreen('input-screen');
            }


            // --- 이벤트 리스너 ---

            createInputForm();

            stagesContainer.addEventListener('input', function(e) {
                if (e.target.type === 'number' && e.target.id.includes('-funds')) {
                    const korWonEl = document.getElementById(e.target.id + '-kor');
                    korWonEl.textContent = numberToKorean(Number(e.target.value));
                }
            });

            stagesContainer.addEventListener('click', function(e) {
                if (e.target.classList.contains('btn-tip')) {
                    const stageId = e.target.dataset.stage;
                    const tipData = tips[stageId];
                    modalTitle.textContent = tipData.title;
                    modalBody.innerHTML = `<ul>${tipData.list.map(item => `<li>${item}</li>`).join('')}</ul>`;
                    tipModal.style.display = 'flex';
                }
            });

            closeModalBtn.onclick = () => tipModal.style.display = 'none';
            alertCloseBtn.onclick = () => alertModal.style.display = 'none';
            window.onclick = (event) => {
                if (event.target == tipModal || event.target == alertModal) {
                    tipModal.style.display = 'none';
                    alertModal.style.display = 'none';
                }
            };

            submitBtn.addEventListener('click', function() {
                const form = document.getElementById('asset-form');
                let isFormValid = true;

                const formData = new FormData(form);
                planData.userInfo = {
                    id: formData.get('student-id'),
                    name: formData.get('student-name')
                };

                form.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));

                if (!planData.userInfo.id || !planData.userInfo.name) {
                    isFormValid = false;
                    if (!planData.userInfo.id) document.getElementById('student-id').classList.add('invalid');
                    if (!planData.userInfo.name) document.getElementById('student-name').classList.add('invalid');
                }

                stages.forEach(stage => {
                    const goal = formData.get(`${stage.id}-goal`);
                    const funds = formData.get(`${stage.id}-funds`);
                    const portfolio = formData.get(`${stage.id}-portfolio`);
                    
                    if (!goal || !funds || !portfolio) {
                        isFormValid = false;
                        if (!goal) document.getElementById(`${stage.id}-goal`).classList.add('invalid');
                        if (!funds) document.getElementById(`${stage.id}-funds`).classList.add('invalid');
                        if (!portfolio) document.getElementById(`${stage.id}-portfolio`).classList.add('invalid');
                    }

                    planData[stage.id] = {
                        goal: goal,
                        funds: Number(funds),
                        portfolio: portfolio
                    };
                });
                
                if (!isFormValid) {
                    showAlert('빈칸이 있습니다. 모두 입력해주세요.');
                    form.querySelector('.invalid')?.focus();
                    return;
                }

                generateResults();
            });

            modifyBtn.addEventListener('click', function() {
                switchScreen('input-screen');
            });

            // PDF 다운로드 로직 (대폭 수정)
            downloadPdfBtn.addEventListener('click', async function() {
                loader.style.display = 'flex';
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const renderArea = document.getElementById('pdf-render-area');
                const pageHeight = pdf.internal.pageSize.getHeight();
                const pageWidth = pdf.internal.pageSize.getWidth();
                const margin = 10;
                let y = margin; // 현재 y 위치

                try {
                    // 폰트 로드 (오류 수정을 위해 .ttf 파일로 변경)
                    const fontResponse = await fetch('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2107@1.1/Pretendard-Regular.ttf');
                    const fontBlob = await fontResponse.blob();
                    const fontBase64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result.split(',')[1]);
                        reader.onerror = reject;
                        reader.readAsDataURL(fontBlob);
                    });
                    pdf.addFileToVFS("Pretendard-Regular.ttf", fontBase64);
                    pdf.addFont("Pretendard-Regular.ttf", "Pretendard", "normal");
                    pdf.setFont("Pretendard");

                    // 렌더링할 섹션 목록 생성
                    const sections = [];
                    
                    // 1. 제목
                    sections.push(`<h1>생애주기 자산관리 계획 보고서</h1>`);
                    
                    // 2. 기본 정보
                    sections.push(`
                        <div class="pdf-section">
                            <h3>기본 정보</h3>
                            <p><span class="label">학번:</span> ${planData.userInfo.id}</p>
                            <p><span class="label">이름:</span> ${planData.userInfo.name}</p>
                        </div>
                    `);

                    // 3. 생애주기별 계획
                    stages.forEach(stage => {
                        const d = planData[stage.id];
                        sections.push(`
                            <div class="pdf-section">
                                <h3>${stage.name} 계획</h3>
                                <p><span class="label">경제 목표:</span></p><div class="value">${d.goal}</div>
                                <p><span class="label">필요 자금:</span></p><div class="value">${numberToKorean(d.funds)}</div>
                                <p><span class="label">자산 포트폴리오:</span></p><div class="value">${d.portfolio}</div>
                            </div>
                        `);
                    });

                    // 4. 분석 결과 제목
                    sections.push(`<h1>분석 결과</h1>`);

                    // 5. 종합 평가
                    const gradesHtml = document.getElementById('grades-container').innerHTML;
                    sections.push(`
                        <div class="pdf-section">
                            <h3>종합 평가</h3>
                            <div class="pdf-grades-container">${gradesHtml}</div>
                        </div>
                    `);

                    // 6. 차트
                    const chartImgData = assetChart.toBase64Image();
                    sections.push(`
                        <div class="pdf-section">
                            <h3>시기별 필요 자금</h3>
                            <img src="${chartImgData}" class="pdf-chart-img">
                        </div>
                    `);

                    // 7. 상세 조언
                    const adviceHtml = document.getElementById('advice-container').innerHTML;
                    sections.push(`<div class="pdf-section"><h3>상세 조언</h3>${adviceHtml}</div>`);

                    // 8. 다짐
                    const commitmentText = document.getElementById('commitment').value;
                    sections.push(`
                        <div class="pdf-section">
                            <h3>앞으로의 다짐</h3>
                            <div class="value">${commitmentText || '작성된 다짐이 없습니다.'}</div>
                        </div>
                    `);

                    // 각 섹션을 순차적으로 렌더링하고 PDF에 추가
                    for (const sectionHtml of sections) {
                        const sectionDiv = document.createElement('div');
                        sectionDiv.className = 'pdf-section';
                        sectionDiv.innerHTML = sectionHtml;
                        renderArea.appendChild(sectionDiv);
                        
                        // 조언 섹션은 펼쳐서 렌더링
                        sectionDiv.querySelectorAll('.advice-content').forEach(el => el.style.display = 'block');

                        const canvas = await html2canvas(sectionDiv, { scale: 2, useCORS: true });
                        const imgData = canvas.toDataURL('image/png');
                        const imgHeight = (canvas.height * (pageWidth - margin * 2)) / canvas.width;

                        if (y + imgHeight > pageHeight - margin) {
                            pdf.addPage();
                            y = margin;
                        }

                        pdf.addImage(imgData, 'PNG', margin, y, pageWidth - margin * 2, imgHeight);
                        y += imgHeight + 5; // 섹션 간 간격

                        renderArea.removeChild(sectionDiv); // 렌더링 후 DOM에서 제거
                    }

                    pdf.save(`${planData.userInfo.id}_${planData.userInfo.name}_자산관리계획.pdf`);

                } catch (error) {
                    console.error("PDF 생성 중 오류 발생:", error);
                    showAlert("PDF를 생성하는 데 문제가 발생했습니다. 잠시 후 다시 시도해주세요.");
                } finally {
                    loader.style.display = 'none';
                }
            });

            restartBtn.addEventListener('click', resetApp);
        });
    </script>
</body>
</html>
